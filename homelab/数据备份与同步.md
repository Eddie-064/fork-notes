
## 数据备份与同步策略


首先列一下已知功能比较 ok 的相关工具：

- [rclone](https://github.com/rclone/rclone): rsync 是一个本地或 ssh 协议的增量备份工具，rclone 的功能类似，但是支持几乎所有常见的远程存储协议，支持加密备份
- [syncthing](https://github.com/syncthing/syncthing): 在多台机器之间进行持续性的增量同步，支持多操作系统，包括 Android/IOS，也提供 UI 界面。
  - 跟我们在 linux 上常用的 rsync 有点类似，不过 rsync 是一个强大的命令行工具
- [restic](https://github.com/restic/restic): 远程增量备份，通过 rclone 支持几乎所有常见协议的远程存储（s3/ssh/smb 等），支持多种备份策略、版本策略、保留策略，支持加密备份。
- [proxmox-backup-server](https://www.proxmox.com/en/proxmox-backup-server)：proxmox 官方推出的一个备份工具。


再列一下我的备份需求：

- PVE 虚拟机备份：本地 SSD 存储不可靠，我已经坏了两个 SSD 盘了，数据丢了两次，充分认识到备份的重要性...
- 手机/电脑数据同步：将手机与电脑的数据同步到 homelab 的 HDD 中，确保数据不丢。
- 备份到云端存储：这个我暂时好像没啥需求，算是终极的数据可靠性方案吧。

手机/电脑数据同步基本可以确定，[syncthing](https://github.com/syncthing/syncthing) 就是最佳选择。

而 PVE 虚拟机备份，我考虑了如下几个方案：

1. proxmox-backup-server
   1. 它的主要好处在于，支持直接在 proxmox-ve 中将其添加为 cluster 级别的 storage，然后就可以通过 PVE 的定时备份任务，直接将数据备份到 proxmox-backup-server 中。但是我遇到这么几个问题，导致我放弃了它:
      1. 一是我想直接把数据通过 SMB 协议备份到 Windows Server 远程存储中，但是将 SMB 挂载磁盘用做  proxmox-backup-server 的 Datastore 会出问题，备份时 pbs 会创建一些特殊的临时文件，可能要用到 SMB 挂载插件不支持的特性，导致操作会失败。
      2. 二是我的 proxmox-backup-server 跟 Windows Server 都跑在 proxmox 虚拟机里面，那它就不能备份它自己，一备份就会卡住。
2. cronab + rclone:
   1. 首先在 PVE DataCenter => Backup 中创建一个定期备份任务，将所有 vm 都备份到 local 存储中，它实际就存储位置为宿主机的 `/var/lib/vz/dump`。
   2. 通过 crontab 定时任务跑脚本，使用 rclone 将每个节点的 `/var/lib/vz/` 中的文件全部通过 SMB 协议同步到 HDD 中。crontab 的运行时间设置在 PVE 完成后为最佳。并且将同步指标上传到 victoria-metrics 监控系统，如果备份功能失效，监控系统将通过短信或邮件告警。
   3. `/var/lib/vz/` 中除了备份文件外还保存了 iso 镜像等文件，这里也一起备份了。
3. [restic](https://github.com/restic/restic): 前面提过了，这是一个专门的备份工具，支持很多备份特性。
   1. restic 看着确实挺棒，但是感觉有点复杂了，很多功能我都不需要。PVE 的备份已经提供了备份的保留策略等功能，我这里实际只需要一个数据同步工具，因此暂时感觉没必要用 restic.

一番研究后抛弃了 proxmox-backup-server，最终选择了最简单的 cronab + rclone 方案，简单实用又符合我自己的需求。



同步脚本也很简单，首先通过 `rclone config` 将所有 PVE 节点加入为 rclone 的 remote，再将 smb 远程存储加进来（也可以手动改 `~/.config/rclone/rclone.conf`）。

然后写了个几行的 shell 脚本：

```shell
# 我的三台 pve 节点，对应的 rclone remote 名称
declare -a pve_nodes=(
  "pve-um560"
  "pve-gtr5"
  "pve-s500plus"
)

# crontab 执行任务，需要指定下配置文件的绝对路径
for node in "${pve_nodes[@]}"; do
  rclone sync --progress \
  --config=/home/ryan/.config/rclone/rclone.conf  \
  ${node}:/var/lib/vz \
  smb-downloads:/Downloads/proxmox-backup/${node}/
done

# TODO 上传监控指标，用于监控任务是否成功。
```

然后手动执行 `/bin/bash /home/ryan/rclone-sync-to-nas.sh > /home/ryan/rclone-sync.log` 看看是否运行正常。


运行没问题后，再添加这么一个每天晚上 5 点（UTC 21 点）多执行的定时任务进行同步，就完成了：

```shell
# 为了均衡负载，建议分钟值随便填个奇数。
17 21 * * * /bin/bash /home/ryan/rclone-sync-to-nas.sh > /home/ryan/rclone-sync.log
```

可以把运行时间调整到 1 分钟后确认下效果，如果要看实时日志可以用 `tail -f /home/ryan/rclone-sync.log` 查看。

如果任务未执行，可以通过 `sudo systmctl status cron` 查看任务执行日志，排查问题。
